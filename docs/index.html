<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>OptionNote Dashboard</title>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css"/>

  <style>
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #ffffff;
      color:#111;
    }
    .wrap{
      max-width: 1400px;
      margin: 0 auto;
      padding: 18px 14px 24px;
    }
    h1{ margin:0 0 10px; font-size:20px; font-weight:700; }
    .sub{ margin:0 0 14px; font-size:13px; color:#444; }

    .bar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 14px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fafafa;
    }
    .btn{
      border:1px solid #ccc;
      background:#fff;
      padding:6px 10px;
      border-radius:8px;
      cursor:pointer;
      font-size: 13px;
    }
    .btn:hover{ background:#f2f2f2; }
    .pill{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #ddd;
      background:#fff;
      color:#333;
    }
    .spacer{ flex:1; }

    table.dataTable{
      background:#fff !important;
      border:1px solid #ddd;
      border-radius: 10px;
      overflow:hidden;
    }
    table.dataTable thead th{
      background:#f6f6f6 !important;
      color:#111 !important;
      border-bottom:1px solid #ddd !important;
      font-weight:700;
      vertical-align: top;
    }

    tr.row-bull td{
      background: #92D050 !important; /* RGB(146,208,80) */
      color:#111 !important;
    }
    tr.row-bear td{
      background: #FFC000 !important; /* RGB(255,192,0) */
      color:#111 !important;
    }
    tr.row-grey td{
      background: #e6e6e6 !important;
      color:#333 !important;
    }

    table.dataTable.hover tbody tr:hover td{ filter: brightness(0.98); }

    .col-filter{
      width: 100%;
      box-sizing: border-box;
      font-size: 12px;
      padding: 4px 6px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-top: 6px;
      background: #fff;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>OptionNote</h1>
    <p class="sub">
      Data: <span class="pill">latest.csv</span>
      <span id="rowInfo" class="pill">Loadingâ€¦</span>
      <span id="modeInfo" class="pill">Mode: ALL</span>
    </p>

    <div class="bar">
      <button class="btn" id="btnNotExp">Show NotExp only (ALL in one page)</button>
      <button class="btn" id="btnAll">Show ALL entries (ALL in one page)</button>

      <div class="spacer"></div>

      <button class="btn" id="btnReset">Reset (reload page)</button>
    </div>

    <table id="tbl" class="display hover" style="width:100%">
      <thead>
        <tr id="hdrRow"></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const BASE_CSV = "latest.csv"; // index.html is in docs/
    const EXP_COL_CANDIDATES = ["Exp?", "Exp.", "Exp"];

    let dt = null;
    let allRows = [];
    let headers = [];
    let expColName = null;

    function detectExpCol(){
      for(const c of EXP_COL_CANDIDATES){
        if(headers.includes(c)) return c;
      }
      return null;
    }

    function buildHeader(){
      const hdr = document.getElementById("hdrRow");
      hdr.innerHTML = "";
      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        hdr.appendChild(th);
      });
    }

    function updateRowInfo(){
      if(!dt) return;
      const info = dt.page.info();
      document.getElementById("rowInfo").textContent =
        `Rows: ${info.recordsDisplay.toLocaleString()} / ${info.recordsTotal.toLocaleString()}`;
    }

    function setModeText(t){
      document.getElementById("modeInfo").textContent = `Mode: ${t}`;
    }

    function buildDataTable(data){
      if(dt){
        dt.destroy();
        $("#tbl tbody").empty();
      }

      // Fill body
      const tbody = document.querySelector("#tbl tbody");
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        headers.forEach(h => {
          const td = document.createElement("td");
          td.textContent = row[h] ?? "";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      dt = $("#tbl").DataTable({
        // IMPORTANT: enable All (-1) option
        pageLength: -1,  // default: ALL in one page
        lengthMenu: [[25,50,100,250,500,-1],[25,50,100,250,500,"All"]],
        order: [],       // start unsorted
        deferRender: true,
        autoWidth: false,

        createdRow: function(row, dataArr){
          const obj = {};
          headers.forEach((h, i) => obj[h] = dataArr[i]);

          const flag = (obj["vecBullBearFlag"] || "").toString().trim().toUpperCase();

          const premRaw = obj["FinalNetPrem"];
          const prem = parseFloat(String(premRaw || "").replace(/,/g, "").trim());
          const premIsNum = !Number.isNaN(prem);

          if(premIsNum && prem <= 0){
            row.classList.add("row-grey");
            return;
          }
          if(flag === "BULL") row.classList.add("row-bull");
          if(flag === "BEAR") row.classList.add("row-bear");
        },

        initComplete: function(){
          const api = this.api();

          // column filter inputs
          api.columns().every(function(){
            const col = this;
            const th = $(col.header());
            th.find("input.col-filter").remove();

            $('<input class="col-filter" type="text" placeholder="filter...">')
              .appendTo(th)
              .on("keyup change clear", function(){
                if(col.search() !== this.value){
                  col.search(this.value).draw();
                }
              });
          });

          updateRowInfo();
        }
      });

      dt.on("draw", function(){ updateRowInfo(); });
      updateRowInfo();
    }

    function showAllEntries(){
      setModeText("ALL");
      buildDataTable(allRows);
      // Force all in one page
      dt.page.len(-1).draw(false);
    }

    function showNotExpOnly(){
      setModeText("NotExp");
      if(!expColName){
        // if no Exp column, fall back
        buildDataTable(allRows);
        dt.page.len(-1).draw(false);
        return;
      }
      const filtered = allRows.filter(r => String(r[expColName] || "").trim().toLowerCase() === "notexp");
      buildDataTable(filtered);
      dt.page.len(-1).draw(false);
    }

    // Reset should behave like F5 (fresh reload)
    function hardReload(){
      // cache-bust query so CSV and HTML are refreshed
      const url = new URL(window.location.href);
      url.searchParams.set("v", Date.now().toString());
      window.location.replace(url.toString());
    }

    // Load CSV (also cache-bust)
    const csvUrl = `${BASE_CSV}?v=${Date.now()}`;

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      dynamicTyping: false,
      skipEmptyLines: true,
      complete: function(results){
        allRows = results.data || [];
        headers = results.meta.fields || [];
        expColName = detectExpCol();

        buildHeader();
        showAllEntries();

        document.getElementById("btnNotExp").addEventListener("click", showNotExpOnly);
        document.getElementById("btnAll").addEventListener("click", showAllEntries);
        document.getElementById("btnReset").addEventListener("click", hardReload);
      },
      error: function(err){
        document.getElementById("rowInfo").textContent = "CSV load failed";
        console.error(err);
        alert("Failed to load latest.csv. Check path / cache.");
      }
    });
  </script>
</body>
</html>
