<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>OptionNote Dashboard</title>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css"/>
  <!-- FixedHeader -->
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css"/>

  <style>
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #ffffff;
      color:#111;
    }
    .wrap{
      max-width: 1400px;
      margin: 0 auto;
      padding: 18px 14px 24px;
    }
    h1{ margin:0 0 10px; font-size:20px; font-weight:700; }
    .sub{ margin:0 0 14px; font-size:13px; color:#444; }

    .bar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 14px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fafafa;
    }
    .btn{
      border:1px solid #ccc;
      background:#fff;
      padding:6px 10px;
      border-radius:8px;
      cursor:pointer;
      font-size: 13px;
    }
    .btn:hover{ background:#f2f2f2; }
    .pill{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #ddd;
      background:#fff;
      color:#333;
    }
    .spacer{ flex:1; }

    select{
      border:1px solid #ccc;
      background:#fff;
      padding:6px 10px;
      border-radius:8px;
      font-size: 13px;
    }

    table.dataTable{
      background:#fff !important;
      border:1px solid #ddd;
      border-radius: 10px;
      overflow:hidden;
    }
    table.dataTable thead th{
      background:#f6f6f6 !important;
      color:#111 !important;
      border-bottom:1px solid #ddd !important;
      font-weight:700;
      vertical-align: top;
    }

    tr.row-bull td{
      background: #92D050 !important; /* RGB(146,208,80) */
      color:#111 !important;
    }
    tr.row-bear td{
      background: #FFC000 !important; /* RGB(255,192,0) */
      color:#111 !important;
    }
    tr.row-grey td{
      background: #e6e6e6 !important;
      color:#333 !important;
    }

    table.dataTable.hover tbody tr:hover td{ filter: brightness(0.98); }

    .col-filter{
      width: 100%;
      box-sizing: border-box;
      font-size: 12px;
      padding: 4px 6px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-top: 6px;
      background: #fff;
    }

    /* make FixedHeader look consistent */
    table.dataTable.fixedHeader-floating{
      border:1px solid #ddd;
      border-radius: 10px;
      overflow:hidden;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>OptionNote</h1>
    <p class="sub">
      Data: <span class="pill">latest.csv</span>
      <span id="rowInfo" class="pill">Loadingâ€¦</span>
      <span id="modeInfo" class="pill">Mode: ALL</span>
      <span id="revInfo" class="pill">Order: normal</span>
    </p>

    <div class="bar">
      <label class="pill" for="ddMonths">Show:</label>
      <select id="ddMonths">
        <option value="all">All</option>
        <option value="1">Latest 1 month</option>
        <option value="2">Latest 2 months</option>
        <option value="3">Latest 3 months</option>
        <option value="4">Latest 4 months</option>
        <option value="5">Latest 5 months</option>
        <option value="6">Latest 6 months</option>
      </select>

      <button class="btn" id="btnNotExp">NotExp only (ALL in one page)</button>
      <button class="btn" id="btnAll">All entries (ALL in one page)</button>

      <div class="spacer"></div>

      <button class="btn" id="btnReverse">Reverse rows</button>
      <button class="btn" id="btnReset">Reset (reload page)</button>
    </div>

    <table id="tbl" class="display hover" style="width:100%">
      <thead>
        <tr id="hdrRow"></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const BASE_CSV = "latest.csv"; // index.html is in docs/
    const EXP_COL_CANDIDATES = ["Exp?", "Exp.", "Exp"];
    const CREATED_DATE_CANDIDATES = ["CreatedDate", "Created Date", "Created_Date"];

    let dt = null;
    let allRows = [];
    let headers = [];
    let expColName = null;
    let createdDateCol = null;

    // State
    let currentMode = "ALL"; // ALL / NotExp
    let monthsWindow = "all"; // 'all' or '1'...'6'
    let reversed = false;

    function detectCol(cands){
      for(const c of cands){
        if(headers.includes(c)) return c;
      }
      return null;
    }

    function setModeText(){
      let m = currentMode;
      if(monthsWindow !== "all") m += ` | last ${monthsWindow}m`;
      document.getElementById("modeInfo").textContent = `Mode: ${m}`;
    }

    function setRevText(){
      document.getElementById("revInfo").textContent = `Order: ${reversed ? "reversed" : "normal"}`;
    }

    function buildHeader(){
      const hdr = document.getElementById("hdrRow");
      hdr.innerHTML = "";
      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        hdr.appendChild(th);
      });
    }

    function updateRowInfo(){
      if(!dt) return;
      const info = dt.page.info();
      document.getElementById("rowInfo").textContent =
        `Rows: ${info.recordsDisplay.toLocaleString()} / ${info.recordsTotal.toLocaleString()}`;
    }

    // Parse CreatedDate:
    // supports "YYYY-MM-DD", "M/D/YYYY", "MM/DD/YYYY"
    function parseDateAny(s){
      if(!s) return null;
      const t = String(s).trim();
      if(!t) return null;

      // YYYY-MM-DD
      let m = t.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(m){
        const y = +m[1], mo = +m[2]-1, d = +m[3];
        const dt = new Date(y, mo, d);
        return isNaN(dt.getTime()) ? null : dt;
      }

      // M/D/YYYY or MM/DD/YYYY
      m = t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if(m){
        const mo = +m[1]-1, d = +m[2], y = +m[3];
        const dt = new Date(y, mo, d);
        return isNaN(dt.getTime()) ? null : dt;
      }

      return null;
    }

    function monthsAgoDate(n){
      const now = new Date();
      const d = new Date(now.getFullYear(), now.getMonth() - n, now.getDate());
      d.setHours(0,0,0,0);
      return d;
    }

    function applyFiltersBase(rows){
      let out = rows;

      // months filter
      if(monthsWindow !== "all" && createdDateCol){
        const cutoff = monthsAgoDate(parseInt(monthsWindow, 10));
        out = out.filter(r => {
          const dt = parseDateAny(r[createdDateCol]);
          return dt && dt >= cutoff;
        });
      }

      // Exp? filter
      if(currentMode === "NotExp" && expColName){
        out = out.filter(r => String(r[expColName] || "").trim().toLowerCase() === "notexp");
      }

      return out;
    }

    function buildDataTable(data){
      if(dt){
        dt.destroy();
        $("#tbl tbody").empty();
      }

      // Fill body
      const tbody = document.querySelector("#tbl tbody");
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        headers.forEach(h => {
          const td = document.createElement("td");
          td.textContent = row[h] ?? "";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      dt = $("#tbl").DataTable({
        pageLength: -1, // ALL in one page
        lengthMenu: [[25,50,100,250,500,-1],[25,50,100,250,500,"All"]],
        order: [],      // start unsorted
        deferRender: true,
        autoWidth: false,
        fixedHeader: true, // sticky header

        createdRow: function(row, dataArr){
          const obj = {};
          headers.forEach((h, i) => obj[h] = dataArr[i]);

          const flag = (obj["vecBullBearFlag"] || "").toString().trim().toUpperCase();

          const premRaw = obj["FinalNetPrem"];
          const prem = parseFloat(String(premRaw || "").replace(/,/g, "").trim());
          const premIsNum = !Number.isNaN(prem);

          if(premIsNum && prem <= 0){
            row.classList.add("row-grey");
            return;
          }
          if(flag === "BULL") row.classList.add("row-bull");
          if(flag === "BEAR") row.classList.add("row-bear");
        },

        initComplete: function(){
          const api = this.api();

          api.columns().every(function(){
            const col = this;
            const th = $(col.header());
            th.find("input.col-filter").remove();

            $('<input class="col-filter" type="text" placeholder="filter...">')
              .appendTo(th)
              .on("keyup change clear", function(){
                if(col.search() !== this.value){
                  col.search(this.value).draw();
                }
              });
          });

          updateRowInfo();
        }
      });

      dt.on("draw", function(){ updateRowInfo(); });
      updateRowInfo();
    }

    function refreshView(){
      // start from base order
      let base = allRows.slice();

      // apply reverse if toggled (reverse the current base order)
      if(reversed) base.reverse();

      // apply mode/month filters
      const filtered = applyFiltersBase(base);

      buildDataTable(filtered);
      setModeText();
      setRevText();
      dt.page.len(-1).draw(false); // ensure single page
    }

    function hardReload(){
      const url = new URL(window.location.href);
      url.searchParams.set("v", Date.now().toString());
      window.location.replace(url.toString());
    }

    // Load CSV with cache-bust
    const csvUrl = `${BASE_CSV}?v=${Date.now()}`;

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      dynamicTyping: false,
      skipEmptyLines: true,
      complete: function(results){
        allRows = results.data || [];
        headers = results.meta.fields || [];

        expColName = detectCol(EXP_COL_CANDIDATES);
        createdDateCol = detectCol(CREATED_DATE_CANDIDATES);

        buildHeader();

        // initial view
        refreshView();

        // UI handlers
        document.getElementById("ddMonths").addEventListener("change", function(){
          monthsWindow = this.value; // 'all' or '1'..'6'
          refreshView();
        });

        document.getElementById("btnNotExp").addEventListener("click", function(){
          currentMode = "NotExp";
          refreshView();
        });

        document.getElementById("btnAll").addEventListener("click", function(){
          currentMode = "ALL";
          refreshView();
        });

        document.getElementById("btnReverse").addEventListener("click", function(){
          reversed = !reversed;
          refreshView();
        });

        document.getElementById("btnReset").addEventListener("click", hardReload);
      },
      error: function(err){
        document.getElementById("rowInfo").textContent = "CSV load failed";
        console.error(err);
        alert("Failed to load latest.csv. Check path / cache.");
      }
    });
  </script>
</body>
</html>
