<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>OptionNote Dashboard</title>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css"/>
  <!-- FixedHeader (IMPORTANT) -->
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css"/>

  <style>
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#ffffff;
      color:#111;
    }
    .wrap{
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px 12px 20px;
    }
    h1{ margin:0 0 8px; font-size:20px; font-weight:700; }
    .sub{ margin:0 0 10px; font-size:13px; color:#444; }

    /* Tabs */
    .tabs{
      display:flex;
      gap:8px;
      align-items:center;
      margin: 8px 0 10px;
      flex-wrap:wrap;
    }
    .tab{
      border:1px solid #ccc;
      background:#fff;
      padding:7px 10px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      font-weight:700;
      white-space:nowrap;
      user-select:none;
    }
    .tab.active{
      background:#111;
      color:#fff;
      border-color:#111;
    }

    .bar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 12px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background:#fafafa;
    }
    .btn{
      border:1px solid #ccc;
      background:#fff;
      padding:7px 10px;
      border-radius:8px;
      cursor:pointer;
      font-size: 13px;
      white-space: nowrap;
    }
    .btn:hover{ background:#f2f2f2; }
    .select{
      border:1px solid #ccc;
      background:#fff;
      padding:7px 10px;
      border-radius:8px;
      font-size: 13px;
    }
    .pill{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #ddd;
      background:#fff;
      color:#333;
      white-space: nowrap;
    }
    .spacer{ flex:1; }

    /* Table container */
    .table-wrap{
      border:1px solid #ddd;
      border-radius: 10px;
      overflow: visible;
      background:#fff;
    }

    table.dataTable{
      background:#fff !important;
      border-collapse: separate !important;
      border-spacing: 0 !important;
      width:100% !important;
    }

    /* Header look */
    table.dataTable thead th{
      background:#f6f6f6 !important;
      color:#111 !important;
      border-bottom:1px solid #ddd !important;
      font-weight:700;
      vertical-align: top;
    }

    /* Row coloring (KeyContracts only) */
    tr.row-bull td{ background:#92D050 !important; color:#111 !important; }
    tr.row-bear td{ background:#FFC000 !important; color:#111 !important; }
    tr.row-grey td{ background:#e6e6e6 !important; color:#333 !important; }

    /* Cell coloring (Agg) */
    td.cell-pos{ background:#92D050 !important; color:#111 !important; }
    td.cell-neg{ background:#FFC000 !important; color:#111 !important; }

    .col-filter{
      width: 100%;
      box-sizing: border-box;
      font-size: 12px;
      padding: 4px 6px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-top: 6px;
      background:#fff;
    }

    @media (max-width: 768px){
      .btn, .select{ font-size:14px; padding:8px 10px; }
      .col-filter{ font-size: 14px; padding: 6px 8px; }
      table.dataTable{ font-size: 12px; }
      .tab{ font-size:14px; padding:8px 12px; }
    }

    /* FixedHeader clone style tweak */
    table.dataTable.fixedHeader-floating thead th,
    table.dataTable.fixedHeader-locked thead th{
      background:#f6f6f6 !important;
    }

    /* Panels */
    .panel{ display:none; }
    .panel.active{ display:block; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>OptionNote</h1>

    <div class="tabs">
      <div class="tab active" id="tabKey">OpFlowKey</div>
      <div class="tab" id="tabAgg">OpFlowAgg</div>
      <span class="pill" id="activeCsvPill">latest.csv</span>
      <span id="rowInfo" class="pill">Loading…</span>
      <span id="metaInfo" class="pill">—</span>
    </div>

    <!-- ===================== -->
    <!-- Panel: OpFlowKey -->
    <!-- ===================== -->
    <div class="panel active" id="panelKey">
      <div class="bar">
        <label class="pill">Range</label>
        <select id="selRangeKey" class="select">
          <option value="all" selected>ALL</option>
          <option value="1">Latest 1 month</option>
          <option value="2">Latest 2 months</option>
          <option value="3">Latest 3 months</option>
          <option value="4">Latest 4 months</option>
          <option value="5">Latest 5 months</option>
          <option value="6">Latest 6 months</option>
        </select>

        <button class="btn" id="btnReverseKey">Reverse rows</button>
        <button class="btn" id="btnResetKey">Reset (reload)</button>

        <div class="spacer"></div>
        <span class="pill">Use search box / column filters</span>
      </div>

      <div class="table-wrap">
        <table id="tblKey" class="display hover" style="width:100%">
          <thead>
            <tr id="hdrRowKey"></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- ===================== -->
    <!-- Panel: OpFlowAgg -->
    <!-- ===================== -->
    <div class="panel" id="panelAgg">
      <div class="bar">
        <label class="pill">Range</label>
        <select id="selRangeAgg" class="select">
          <option value="all" selected>ALL</option>
          <option value="1w">Latest 1 week</option>
          <option value="2w">Latest 2 weeks</option>
          <option value="3w">Latest 3 weeks</option>
          <option value="6w">Latest 6 weeks</option>
          <option value="1m">Latest 1 month</option>
          <option value="2m">Latest 2 months</option>
          <option value="3m">Latest 3 months</option>
          <option value="5m">Latest 5 months</option>
        </select>

        <button class="btn" id="btnReverseAgg">Reverse rows</button>
        <button class="btn" id="btnResetAgg">Reset (reload)</button>

        <div class="spacer"></div>
        <span class="pill">Cells >= 1,000,000 green | <= -1,000,000 orange</span>
      </div>

      <div class="table-wrap">
        <table id="tblAgg" class="display hover" style="width:100%">
          <thead>
            <tr id="hdrRowAgg"></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- jQuery + DataTables + FixedHeader + PapaParse -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // =========================
    // Shared helpers
    // =========================
    function hardReload(){
      const url = new URL(window.location.href);
      url.searchParams.set("v", Date.now().toString());
      window.location.replace(url.toString());
    }

    function parseDate(val){
      if(val == null) return null;
      const s0 = String(val).trim();
      if(!s0) return null;

      let d = new Date(s0);
      if(!isNaN(d)) return d;

      const m = s0.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if(m){
        d = new Date(parseInt(m[3],10), parseInt(m[1],10)-1, parseInt(m[2],10));
        if(!isNaN(d)) return d;
      }

      const m2 = s0.match(/^(\d{4})(\d{2})(\d{2})$/);
      if(m2){
        d = new Date(parseInt(m2[1],10), parseInt(m2[2],10)-1, parseInt(m2[3],10));
        if(!isNaN(d)) return d;
      }

      return null;
    }

    function monthsAgoDate(n){
      const now = new Date();
      return new Date(now.getFullYear(), now.getMonth() - n, now.getDate());
    }

    function daysAgoDate(days){
      const now = new Date();
      return new Date(now.getTime() - days*24*60*60*1000);
    }

    function parseMoney(val){
      if(val == null) return null;
      const s = String(val).trim();
      if(!s) return null;

      let neg = false;
      let t = s;

      if(t.startsWith("(") && t.endsWith(")")){
        neg = true;
        t = t.slice(1, -1);
      }

      t = t.replace(/,/g, "").trim();
      const n = parseFloat(t);
      if(Number.isNaN(n)) return null;
      return neg ? -n : n;
    }

    function updateRowInfoFromDT(dt){
      if(!dt) return;
      const info = dt.page.info();
      document.getElementById("rowInfo").textContent =
        `Rows: ${info.recordsDisplay.toLocaleString()} / ${info.recordsTotal.toLocaleString()}`;
    }

    function setMeta(text){
      document.getElementById("metaInfo").textContent = text;
    }

    function adjustDT(dt){
      if(!dt) return;
      try{
        dt.columns.adjust();
        if(dt.fixedHeader && typeof dt.fixedHeader.adjust === "function"){
          dt.fixedHeader.adjust();
        }
      }catch(e){}
    }

    // =========================
    // TAB handling
    // =========================
    const tabKey = document.getElementById("tabKey");
    const tabAgg = document.getElementById("tabAgg");
    const panelKey = document.getElementById("panelKey");
    const panelAgg = document.getElementById("panelAgg");
    const activeCsvPill = document.getElementById("activeCsvPill");

    function activateTab(which){
      const isKey = (which === "KEY");
      tabKey.classList.toggle("active", isKey);
      tabAgg.classList.toggle("active", !isKey);
      panelKey.classList.toggle("active", isKey);
      panelAgg.classList.toggle("active", !isKey);
      activeCsvPill.textContent = isKey ? "latest.csv" : "latestAgg.csv";

      // IMPORTANT: Agg is lazy-init to avoid FixedHeader cloning wrong header while hidden
      if(!isKey){
        ensureAggInit();
      }

      // Let layout settle then adjust fixed header
      setTimeout(() => {
        if(isKey){
          adjustDT(dtKey);
          updateRowInfoFromDT(dtKey);
        }else{
          adjustDT(dtAgg);
          updateRowInfoFromDT(dtAgg);
        }
      }, 50);
    }

    tabKey.addEventListener("click", () => activateTab("KEY"));
    tabAgg.addEventListener("click", () => activateTab("AGG"));

    // =========================
    // OpFlowKey
    // =========================
    const BASE_CSV_KEY = "latest.csv";
    const DATE_COL_CANDIDATES_KEY = ["CreatedDate", "As.Date", "As Date", "As.Date.", "AsDate"];

    let dtKey = null;
    let headersKey = [];
    let allRowsKey = [];
    let isReversedKey = false;
    let dateColKey = null;

    function detectDateColKey(){
      for(const c of DATE_COL_CANDIDATES_KEY){
        if(headersKey.includes(c)) return c;
      }
      return null;
    }

    function buildHeaderKey(){
      const hdr = document.getElementById("hdrRowKey");
      hdr.innerHTML = "";
      headersKey.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        hdr.appendChild(th);
      });
    }

    function buildDataTableKey(data){
      if(dtKey){
        dtKey.destroy();
        $("#tblKey tbody").empty();
      }

      const tbody = document.querySelector("#tblKey tbody");
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        headersKey.forEach(h => {
          const td = document.createElement("td");
          td.textContent = row[h] ?? "";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      dtKey = $("#tblKey").DataTable({
        pageLength: -1,
        lengthMenu: [[25,50,100,250,500,-1],[25,50,100,250,500,"All"]],
        order: [],
        deferRender: true,
        autoWidth: false,
        fixedHeader: true,

        createdRow: function(row, dataArr){
          const obj = {};
          headersKey.forEach((h, i) => obj[h] = dataArr[i]);

          const flag = (obj["vecBullBearFlag"] || "").toString().trim().toUpperCase();
          const premRaw = obj["FinalNetPrem"];
          const prem = parseFloat(String(premRaw || "").replace(/,/g, "").trim());
          const premIsNum = !Number.isNaN(prem);

          if(premIsNum && prem <= 0){
            row.classList.add("row-grey");
            return;
          }
          if(flag === "BULL") row.classList.add("row-bull");
          if(flag === "BEAR") row.classList.add("row-bear");
        },

        initComplete: function(){
          const api = this.api();
          api.columns().every(function(){
            const col = this;
            const th = $(col.header());
            th.find("input.col-filter").remove();

            $('<input class="col-filter" type="text" placeholder="filter...">')
              .appendTo(th)
              .on("keyup change clear", function(){
                if(col.search() !== this.value){
                  col.search(this.value).draw();
                }
              });
          });

          updateRowInfoFromDT(dtKey);
          adjustDT(dtKey);
        }
      });

      dtKey.on("draw", function(){ updateRowInfoFromDT(dtKey); });
      updateRowInfoFromDT(dtKey);
      adjustDT(dtKey);
    }

    function applyRangeAndReverseKey(){
      const sel = document.getElementById("selRangeKey").value;
      let rows = allRowsKey.slice();

      if(sel !== "all" && dateColKey){
        const n = parseInt(sel, 10);
        const cutoff = monthsAgoDate(n);
        rows = rows.filter(r => {
          const d = parseDate(r[dateColKey]);
          return d && d >= cutoff;
        });
      }

      if(isReversedKey) rows.reverse();

      buildDataTableKey(rows);

      const rangeText = (sel === "all") ? "ALL" : `Latest ${sel} month(s)`;
      const revText = isReversedKey ? "Reversed" : "Normal";
      const dateText = dateColKey ? `DateCol=${dateColKey}` : "DateCol=NONE";
      setMeta(`OpFlowKey | ${rangeText} | ${revText} | ${dateText}`);
    }

    // =========================
    // OpFlowAgg (LAZY INIT)
    // =========================
    const BASE_CSV_AGG = "latestAgg.csv";
    const DATE_COL_CANDIDATES_AGG = ["CreateDate", "CreatedDate", "As.Date", "As Date", "Date", "Created"];

    let dtAgg = null;
    let headersAgg = [];
    let allRowsAgg = [];
    let isReversedAgg = false;
    let dateColAgg = null;

    let aggLoaded = false;
    let aggInitDone = false;

    function detectDateColAgg(){
      for(const c of DATE_COL_CANDIDATES_AGG){
        if(headersAgg.includes(c)) return c;
      }
      return null;
    }

    function buildHeaderAgg(){
      const hdr = document.getElementById("hdrRowAgg");
      hdr.innerHTML = "";
      headersAgg.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        hdr.appendChild(th);
      });
    }

    function buildDataTableAgg(data){
      if(dtAgg){
        dtAgg.destroy();
        $("#tblAgg tbody").empty();
      }

      const tbody = document.querySelector("#tblAgg tbody");
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        headersAgg.forEach(h => {
          const td = document.createElement("td");
          td.textContent = row[h] ?? "";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      dtAgg = $("#tblAgg").DataTable({
        pageLength: -1,
        lengthMenu: [[50,100,200,300,500,-1],[50,100,200,300,500,"All"]],
        order: [],
        deferRender: true,
        autoWidth: false,
        fixedHeader: true,

        createdRow: function(row, dataArr){
          const tds = row.querySelectorAll("td");
          for(let i=0;i<tds.length;i++){
            const n = parseMoney(dataArr[i]);
            if(n == null) continue;
            if(n >= 1000000) tds[i].classList.add("cell-pos");
            else if(n <= -1000000) tds[i].classList.add("cell-neg");
          }
        },

        initComplete: function(){
          const api = this.api();
          api.columns().every(function(){
            const col = this;
            const th = $(col.header());
            th.find("input.col-filter").remove();

            $('<input class="col-filter" type="text" placeholder="filter...">')
              .appendTo(th)
              .on("keyup change clear", function(){
                if(col.search() !== this.value){
                  col.search(this.value).draw();
                }
              });
          });

          updateRowInfoFromDT(dtAgg);
          adjustDT(dtAgg);
        }
      });

      dtAgg.on("draw", function(){ updateRowInfoFromDT(dtAgg); });
      updateRowInfoFromDT(dtAgg);
      adjustDT(dtAgg);
    }

    function rangeAggToCutoff(sel){
      if(sel === "all") return null;
      if(sel === "1w") return daysAgoDate(7);
      if(sel === "2w") return daysAgoDate(14);
      if(sel === "3w") return daysAgoDate(21);
      if(sel === "6w") return daysAgoDate(42);
      if(sel === "1m") return monthsAgoDate(1);
      if(sel === "2m") return monthsAgoDate(2);
      if(sel === "3m") return monthsAgoDate(3);
      if(sel === "5m") return monthsAgoDate(5);
      return null;
    }

    function applyRangeAndReverseAgg(){
      const sel = document.getElementById("selRangeAgg").value;
      let rows = allRowsAgg.slice();

      const cutoff = rangeAggToCutoff(sel);
      if(cutoff && dateColAgg){
        rows = rows.filter(r => {
          const d = parseDate(r[dateColAgg]);
          return d && d >= cutoff;
        });
      }

      if(isReversedAgg) rows.reverse();

      buildDataTableAgg(rows);

      const rangeText = (sel === "all") ? "ALL" : `Latest ${sel}`;
      const revText = isReversedAgg ? "Reversed" : "Normal";
      const dateText = dateColAgg ? `DateCol=${dateColAgg}` : "DateCol=NONE";
      setMeta(`OpFlowAgg | ${rangeText} | ${revText} | ${dateText}`);
    }

    function ensureAggInit(){
      if(aggInitDone) return;
      if(!aggLoaded){
        setMeta("OpFlowAgg not loaded yet...");
        return;
      }
      // Panel is visible now -> safe to init DataTable with FixedHeader
      buildHeaderAgg();
      applyRangeAndReverseAgg();

      document.getElementById("selRangeAgg").addEventListener("change", applyRangeAndReverseAgg);

      document.getElementById("btnReverseAgg").addEventListener("click", function(){
        isReversedAgg = !isReversedAgg;
        applyRangeAndReverseAgg();
      });

      document.getElementById("btnResetAgg").addEventListener("click", hardReload);

      aggInitDone = true;
      setTimeout(() => adjustDT(dtAgg), 50);
    }

    // =========================
    // CSV loader
    // =========================
    function loadCsv(url, onOk, onFail){
      Papa.parse(url, {
        download: true,
        header: true,
        dynamicTyping: false,
        skipEmptyLines: true,
        complete: function(results){ onOk(results); },
        error: function(err){ onFail(err); }
      });
    }

    // Load Key (init immediately, visible)
    const csvUrlKey = `${BASE_CSV_KEY}?v=${Date.now()}`;
    loadCsv(csvUrlKey,
      function(results){
        allRowsKey = results.data || [];
        headersKey = results.meta.fields || [];
        dateColKey = detectDateColKey();

        buildHeaderKey();
        applyRangeAndReverseKey();

        document.getElementById("selRangeKey").addEventListener("change", applyRangeAndReverseKey);

        document.getElementById("btnReverseKey").addEventListener("click", function(){
          isReversedKey = !isReversedKey;
          applyRangeAndReverseKey();
        });

        document.getElementById("btnResetKey").addEventListener("click", hardReload);

        activateTab("KEY");
      },
      function(err){
        document.getElementById("rowInfo").textContent = "CSV load failed";
        console.error(err);
        alert("Failed to load latest.csv. Check path / cache.");
      }
    );

    // Load Agg (ONLY load data; init later when tab shown)
    const csvUrlAgg = `${BASE_CSV_AGG}?v=${Date.now()}`;
    loadCsv(csvUrlAgg,
      function(results){
        allRowsAgg = results.data || [];
        headersAgg = results.meta.fields || [];
        dateColAgg = detectDateColAgg();
        aggLoaded = true;
        // do NOT init dtAgg here (panel hidden) -> lazy init
      },
      function(err){
        console.error(err);
        aggLoaded = false;
        setMeta("OpFlowAgg load failed (latestAgg.csv missing?)");
      }
    );
  </script>
</body>
</html>
