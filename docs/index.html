<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>OptionNote Dashboard</title>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css"/>

  <style>
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#ffffff;
      color:#111;
    }
    .wrap{
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px 12px 20px;
    }
    h1{ margin:0 0 8px; font-size:20px; font-weight:700; }
    .sub{ margin:0 0 10px; font-size:13px; color:#444; }

    .bar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 12px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background:#fafafa;
    }
    .btn{
      border:1px solid #ccc;
      background:#fff;
      padding:7px 10px;
      border-radius:8px;
      cursor:pointer;
      font-size: 13px;
      white-space: nowrap;
    }
    .btn:hover{ background:#f2f2f2; }
    .select{
      border:1px solid #ccc;
      background:#fff;
      padding:7px 10px;
      border-radius:8px;
      font-size: 13px;
    }
    .pill{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #ddd;
      background:#fff;
      color:#333;
      white-space: nowrap;
    }
    .spacer{ flex:1; }

    /* ===== Table wrapper =====
       Desktop: normal page scroll is fine.
       Mobile: make a scroll area so header sticky works reliably after reaching table.
    */
    .table-wrap{
      border:1px solid #ddd;
      border-radius: 10px;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      background:#fff;
    }
    @media (max-width: 768px){
      .table-wrap{ max-height: 72vh; }
      .btn, .select{ font-size:14px; padding:8px 10px; }
    }

    table.dataTable{
      background:#fff !important;
      border-collapse: separate !important;
      border-spacing: 0 !important;
      width:100% !important;
    }

    /* Sticky header inside table-wrap */
    table.dataTable thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background:#f6f6f6 !important;
      color:#111 !important;
      border-bottom:1px solid #ddd !important;
      font-weight:700;
      vertical-align: top;
    }

    tr.row-bull td{ background:#92D050 !important; color:#111 !important; }
    tr.row-bear td{ background:#FFC000 !important; color:#111 !important; }
    tr.row-grey td{ background:#e6e6e6 !important; color:#333 !important; }

    .col-filter{
      width: 100%;
      box-sizing: border-box;
      font-size: 12px;
      padding: 4px 6px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-top: 6px;
      background:#fff;
    }
    @media (max-width: 768px){
      .col-filter{ font-size: 14px; padding: 6px 8px; }
      table.dataTable{ font-size: 12px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>OptionNote</h1>
    <p class="sub">
      <span class="pill">latest.csv</span>
      <span id="rowInfo" class="pill">Loading…</span>
      <span id="metaInfo" class="pill">—</span>
    </p>

    <div class="bar">
      <label class="pill">Range</label>
      <select id="selRange" class="select">
        <option value="all" selected>ALL</option>
        <option value="1">Latest 1 month</option>
        <option value="2">Latest 2 months</option>
        <option value="3">Latest 3 months</option>
        <option value="4">Latest 4 months</option>
        <option value="5">Latest 5 months</option>
        <option value="6">Latest 6 months</option>
      </select>

      <button class="btn" id="btnReverse">Reverse rows</button>
      <button class="btn" id="btnReset">Reset (reload)</button>

      <div class="spacer"></div>
      <span class="pill">Tip: use search box / column filters</span>
    </div>

    <div class="table-wrap" id="tableWrap">
      <table id="tbl" class="display hover" style="width:100%">
        <thead>
          <tr id="hdrRow"></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const BASE_CSV = "latest.csv";
    const DATE_COL_CANDIDATES = ["CreatedDate", "As.Date", "As Date", "As.Date.", "AsDate"];

    let dt = null;
    let headers = [];
    let allRows = [];       // raw rows
    let workingRows = [];   // after range + reverse
    let isReversed = false;
    let dateCol = null;

    function detectDateCol(){
      for(const c of DATE_COL_CANDIDATES){
        if(headers.includes(c)) return c;
      }
      return null;
    }

    function parseDate(val){
      // Accept: YYYY-MM-DD, YYYY/MM/DD, M/D/YYYY, MM/DD/YYYY
      if(val == null) return null;
      const s0 = String(val).trim();
      if(!s0) return null;

      // If already ISO-like
      let d = new Date(s0);
      if(!isNaN(d)) return d;

      // Try M/D/YYYY or MM/DD/YYYY
      const m = s0.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if(m){
        const mm = parseInt(m[1],10);
        const dd = parseInt(m[2],10);
        const yy = parseInt(m[3],10);
        d = new Date(yy, mm-1, dd);
        if(!isNaN(d)) return d;
      }
      return null;
    }

    function monthsAgoDate(n){
      const now = new Date();
      const d = new Date(now.getFullYear(), now.getMonth() - n, now.getDate());
      return d;
    }

    function buildHeader(){
      const hdr = document.getElementById("hdrRow");
      hdr.innerHTML = "";
      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        hdr.appendChild(th);
      });
    }

    function updateRowInfo(){
      if(!dt) return;
      const info = dt.page.info();
      document.getElementById("rowInfo").textContent =
        `Rows: ${info.recordsDisplay.toLocaleString()} / ${info.recordsTotal.toLocaleString()}`;
    }

    function setMeta(text){
      document.getElementById("metaInfo").textContent = text;
    }

    function buildDataTable(data){
      if(dt){
        dt.destroy();
        $("#tbl tbody").empty();
      }

      const tbody = document.querySelector("#tbl tbody");
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        headers.forEach(h => {
          const td = document.createElement("td");
          td.textContent = row[h] ?? "";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      dt = $("#tbl").DataTable({
        pageLength: -1, // always show ALL rows in one page
        lengthMenu: [[25,50,100,250,500,-1],[25,50,100,250,500,"All"]],
        order: [],      // no initial sort
        deferRender: true,
        autoWidth: false,

        createdRow: function(row, dataArr){
          const obj = {};
          headers.forEach((h, i) => obj[h] = dataArr[i]);

          const flag = (obj["vecBullBearFlag"] || "").toString().trim().toUpperCase();

          const premRaw = obj["FinalNetPrem"];
          const prem = parseFloat(String(premRaw || "").replace(/,/g, "").trim());
          const premIsNum = !Number.isNaN(prem);

          // Grey overrides bull/bear
          if(premIsNum && prem <= 0){
            row.classList.add("row-grey");
            return;
          }
          if(flag === "BULL") row.classList.add("row-bull");
          if(flag === "BEAR") row.classList.add("row-bear");
        },

        initComplete: function(){
          const api = this.api();

          // per-column filters
          api.columns().every(function(){
            const col = this;
            const th = $(col.header());
            th.find("input.col-filter").remove();

            $('<input class="col-filter" type="text" placeholder="filter...">')
              .appendTo(th)
              .on("keyup change clear", function(){
                if(col.search() !== this.value){
                  col.search(this.value).draw();
                }
              });
          });

          updateRowInfo();
        }
      });

      dt.on("draw", function(){ updateRowInfo(); });
      updateRowInfo();
    }

    function applyRangeAndReverse(){
      const sel = document.getElementById("selRange").value;

      let rows = allRows.slice();

      // Range filter by date (if date column exists)
      if(sel !== "all" && dateCol){
        const n = parseInt(sel, 10);
        const cutoff = monthsAgoDate(n);

        rows = rows.filter(r => {
          const d = parseDate(r[dateCol]);
          return d && d >= cutoff;
        });
      }

      // Reverse rows if requested
      if(isReversed){
        rows.reverse();
      }

      workingRows = rows;
      buildDataTable(workingRows);

      const rangeText = (sel === "all") ? "ALL" : `Latest ${sel} month(s)`;
      const revText = isReversed ? "Reversed" : "Normal";
      const dateText = dateCol ? `DateCol=${dateCol}` : "DateCol=NONE";
      setMeta(`${rangeText} | ${revText} | ${dateText}`);
    }

    function hardReload(){
      const url = new URL(window.location.href);
      url.searchParams.set("v", Date.now().toString());
      window.location.replace(url.toString());
    }

    // Load CSV (cache-bust)
    const csvUrl = `${BASE_CSV}?v=${Date.now()}`;

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      dynamicTyping: false,
      skipEmptyLines: true,
      complete: function(results){
        allRows = results.data || [];
        headers = results.meta.fields || [];

        dateCol = detectDateCol();

        buildHeader();
        applyRangeAndReverse();

        document.getElementById("selRange").addEventListener("change", applyRangeAndReverse);

        document.getElementById("btnReverse").addEventListener("click", function(){
          isReversed = !isReversed;
          applyRangeAndReverse();
        });

        document.getElementById("btnReset").addEventListener("click", hardReload);
      },
      error: function(err){
        document.getElementById("rowInfo").textContent = "CSV load failed";
        console.error(err);
        alert("Failed to load latest.csv. Check path / cache.");
      }
    });
  </script>
</body>
</html>
